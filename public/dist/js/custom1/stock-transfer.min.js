"use strict";if($(".error").hide(),$(".main-body .page-wrapper").find("#stock-transfer-add").length){var count_rows,stack=[];function in_array(t,e){for(var a=0;a<e.length;a++)if(e[a]==t)return!0;return!1}function calculateTotalQty(){var t=0;return $(".no_units").each(function(){t+=parseFloat($(this).val()?validateNumbers($(this).val()):0)}),0==t?$("#btnSubmit").attr("disabled","true"):t>0&&$("#btnSubmit").removeAttr("disabled"),t}$(".js-example-basic-single").select2(),$("#transferTbl").DataTable({paging:!1,searching:!1,bInfo:!1,ordering:!1,language:{url:app_locale_url}}),$(document).on("click",function(t){t.target.id,$("#no_div").hide()}),$("#datepicker").daterangepicker(dateSingleConfig(),function(t,e){$("#datepicker").val(moment(t,"MMMM D, YYYY").format(dateFormat.toUpperCase()))}),$("#transferForm").validate({rules:{source:{required:!0},destination:{required:!0},transfer_date:{required:!0},"quantity[]":{required:!0}},messages:{"quantity[]":{required:""}},submitHandler:function(){return""==$("#destination").val().trim()&&$("#destination-error").show(),""==$("#source").val().trim()&&$("#source-error").show(),0!=document.getElementsByClassName("addedRow").length||(swal({text:jsLang("Please select at least one item to transfer"),icon:"error",buttons:[!1,jsLang("Ok")],dangerMode:!0}),!1)}}),$(document).on("click","#btnSubmit",function(){$("input[type=text]").each(function(){if($(this).hasClass("error"))return $(this).focus(),!1})}),$(window).keydown(function(t){if(13==t.keyCode)return t.preventDefault(),!1}),$("#transferTbl").on("click",".delete_item",function(){var t=$(this).attr("id");stack=jQuery.grep(stack,function(e){return e!=t}),$(this).closest("tr").remove();var e=calculateTotalQty();$("#total_qty").text(getDecimalNumberFormat(e)),0==(count_rows=$(".insufficient").length)&&$("#errorMessage").hide()});let t,e=0;function deleteAddedRows(){$(".addedRow").each(function(){$(this).closest("tr").remove()})}$(document).on("keydown",".no_units",function(t){e=$(this).val()}),$("#search").autocomplete({delay:500,position:{my:"left top",at:"left bottom",collision:"flip"},source:function(t,e){var a=$("#source").val(),r=$("#destination").val();return a?($("#error_message").html(""),a&&!r?($("#error_message").html(jsLang("Please select Destination")),$("#destination").select2("open"),!1):void $.ajax({url:SITE_URL+"/stock_transfer/search",type:"post",dataType:"json",data:{_token:token,search:t.term,location:a},success:function(t){if(1==t.status_no){$("#error_message").html(""),$("#val_item").html();t=t.items;$("#no_div").css("display","none"),e($.map(t,function(t){return{id:t.id,value:t.name,available:t.available,is_stock_managed:t.is_stock_managed}}))}else $(".ui-menu-item").remove(),$("#no_div").css("display","block")}})):($("#error_message").html(jsLang("Please select Source and Destination")),$("#source").select2("open"),$("html, body").animate({scrollTop:0},500),!1)},select:function(t,e){var a=e.item;if(a.id){if(1==a.is_stock_managed&&a.available<=0)return swal(a.available+jsLang(" item(s) available in stock"),{icon:"error",buttons:[!1,jsLang("Ok")]}),!1;if(in_array(a.id,stack))$("#qty_"+a.id).val(function(t,e){return e=validateNumbers(e),parseFloat(a.available)<parseFloat(e)+1?(swal(a.available+jsLang(" item(s) available in stock"),{icon:"error",buttons:[!1,jsLang("Ok")]}),getDecimalNumberFormat(e)):Number.isInteger(parseFloat(e))?($("#qty_"+a.id).trigger("change"),parseFloat(++e)):($("#qty_"+a.id).trigger("change"),getDecimalNumberFormat(++e))});else{var r='<tr class="addedRow" id="rowid'+a.id+'"><td class="text-center">'+a.value+'<input type="hidden" name="description[]" value="'+a.value+'"><input type="hidden" name="stock[]" value="'+a.id+'"></td><td><input class="form-control text-center no_units m-b-5 positive-float-number" stock-id="'+a.id+'" id="qty_'+a.id+'" data-id="'+a.id+'" type="text" required name="quantity[]" value="1"><label id="qty_'+a.id+'-error" class="error labelMinMax" for="qty_'+a.id+'"></label><div class="availableStock color_red f-bold" id="errorMessage-'+a.id+'"></div><input type="hidden" name="id[]" value="'+a.id+'"></td><td class="text-center"><button id="'+a.id+'" class="btn btn-xs btn-danger delete_item"><i class="feather icon-trash-2"></i></button></td></tr>';stack.length<=0&&$(".dataTables_empty").parent().remove(),$("#item-body").append(r),stack.push(a.id)}$(this).val(""),$.ajax({method:"POST",url:SITE_URL+"/stock_transfer/check-item-qty",data:{item_id:a.id,_token:token,source:$("#source").val()}}).done(function(t){t=JSON.parse(t);$("#qty_"+t.item_id).attr("data-max",t.qty);var e=$("#qty_"+a.id).val();if(e>t.qty){$("#qty_"+a.id).val(e),$("#qty_"+a.id).attr("data-max",t.qty),$("#qty_"+a.id).trigger("input"),$("#errorMessage").html(t.message);var r=calculateTotalQty();$("#total_qty").text(getDecimalNumberFormat(r))}});var n=calculateTotalQty();return $("#total_qty").text(getDecimalNumberFormat(n)),!1}},minLength:1,autoFocus:!0}).on("focus",function(){$(this).autocomplete("search")}).autocomplete("instance")._renderItem=function(t,e){var a;return a=1==e.is_stock_managed?e.available:"-",$("<li>").append("<div>"+e.value+"<br>Available: "+a+"</div>").appendTo(t)},$(document).on("keyup change input",".no_units",function(t){$(this).attr("stock-id");var a=parseFloat(validateNumbers($(this).val())),r=parseFloat($(this).attr("old-qty")),n=$("#token").val(),i=$("#source").val(),o=$(this).attr("data-id");""==$("#qty_"+o).val().replace(/^\.|[^\d\.]/g,"")&&$("#qty_"+o).val(""),$.ajax({method:"POST",url:SITE_URL+"/stock_transfer/check-item-qty",data:{item_id:o,source:i,_token:n}}).done(function(t){t=JSON.parse(t);if(a<0&&($("#qty_"+o).val(""),$("#errorMessage-"+o).html("")),void 0===r||null==r||isNaN(r))if(r=0,a>t.qty){$("#qty_"+o).attr("data-max",Number(r)+Number(t.qty));var n=$("#qty_"+o).attr("data-max");if(Number(a)>Number(n))return $("#qty_"+o).val(e),swal(t.qty+jsLang(" item(s) available in stock"),{icon:"error"}),$("#qty_"+o).val(e),i=calculateTotalQty(),$("#total_qty").text(getDecimalNumberFormat(i)),getDecimalNumberFormat(e);var i=calculateTotalQty();$("#total_qty").text(getDecimalNumberFormat(i)),$("#errorMessage-"+o).html(t.message)}else $("#errorMessage-"+o).html("");else{Number(t.qty)>=Number(a)-Number(r)?($("#qty_"+o).val(a),$("#errorMessage-"+o).html("")):(isNaN($("#qty_"+o).val())?$("#qty_"+o).val(1):""==$("#qty_"+o).val()?$("#qty_"+o).val(""):$("#qty_"+o).val(r),$("#errorMessage-"+o).html(t.message));i=calculateTotalQty();$("#total_qty").text(getDecimalNumberFormat(i))}});var s=calculateTotalQty();$("#total_qty").text(getDecimalNumberFormat(s))}),$("#source").on("change",function(){stack=[],$(".error").hide(),$("#errorMessage").text(" ");var e=$(this).val();""==e.trim()?$("#source-error").show():$("#source-error").hide();$("#destination").val();null!=t&&1==$("#transferTbl tr").hasClass("addedRow")?swal({title:jsLang("Are you sure"),text:jsLang("Change of location will reset added products/services, please confirm you really want to do this."),icon:"warning",buttons:[jsLang("Cancel"),jsLang("Ok")],dangerMode:!0}).then(a=>{a?($(".closeRow").trigger("click"),deleteAddedRows(),$("#total_qty").text("0"),""!=t&&$("#source-error").css("display","none"),$.ajax({method:"POST",url:SITE_URL+"/stock_transfer/get-destination",data:{source:e,_token:token}}).done(function(t){1==(t=JSON.parse(t)).status_no&&($("#destination").html(t.destination),$("#destination").select2("open"))})):($("#source").val(t),$("#source").trigger("change.select2"))}):(t=$("#source").val(),$.ajax({method:"POST",url:SITE_URL+"/stock_transfer/get-destination",data:{source:e,_token:token}}).done(function(t){1==(t=JSON.parse(t)).status_no&&($("#destination").html(t.destination),$("#destination").select2("open"))}))}),$("#destination").on("change",function(){var t=$("#destination").val(),e=$("#source").val();""==t.trim()&&$("#destination-error").show(),e&&t&&($("#error_message").html(""),""!=$("#search").val()&&$("#search").trigger("focus"),$("#destination-error").hide())}),jQuery.extend(jQuery.validator.messages,{number:jQuery.validator.format("")}),$(document).on("click",".no_units",function(t){$(".labelMinMax").css("display","none")}),$(document).on("click",function(t){$(".labelMinMax").css("display","none"),$(".labelMinMax").css("position","fixed")}),$("#btnSubmit").on("click",function(){1==$("form#transferForm").valid()&&($("#btnSubmit").attr("disabled","disabled"),$("form#transferForm").trigger("submit"))})}if($(".main-body .page-wrapper").find("#stock-transfer-details").length&&$("#transferTbl").DataTable({responsive:!0,language:{url:app_locale_url},paging:!1,searching:!1,bInfo:!1,ordering:!1}),$(".main-body .page-wrapper").find("#orderListFilter").length){let t;$(document).on("click","#csv, #pdf",function(t){t.preventDefault(),window.location=SITE_URL+"/stock/transfer-"+this.id+"?to="+$("#endto").val()+"&from="+$("#startfrom").val()+"&source="+$("#source").val()+"&destination="+$("#destination").val()}),$("#source").on("change",function(){$(".error").hide(),$("#errorMessage").text(" ");var e=$(this).val();""==e.trim()?$("#source-error").show():$("#source-error").hide();$("#destination").val();null!=t?$.ajax({method:"POST",url:SITE_URL+"/stock_transfer/get-destination",data:{source:e,_token:token}}).done(function(t){1==(t=JSON.parse(t)).status_no&&($("#destination").html(t.destination),$("#destination").select2("open"))}):(t=$("#source").val(),$.ajax({method:"POST",url:SITE_URL+"/stock_transfer/get-destination",data:{source:e,_token:token}}).done(function(t){1==(t=JSON.parse(t)).status_no&&($("#destination").html(t.destination),$("#destination").select2("open"))}))}),$("#destination").on("change",function(){var t=$("#destination").val(),e=$("#source").val();""==t.trim()&&$("#destination-error").show(),e&&t&&($("#error_message").html(""),""!=$("#search").val()&&$("#search").trigger("focus"),$("#destination-error").hide())}),$("#dataTableBuilder").addClass("stock-transfer-list")}if($(".main-body .page-wrapper").find("#card-with-header-buttons").length){var oldQuantity=0;function in_array(t,e){for(var a=0;a<e.length;a++)if(e[a]==t)return!0;return!1}$(".js-example-basic-single").select2(),$("select").prop("disabled",!0),$("#transferTbl").DataTable({responsive:!0,language:{url:app_locale_url},paging:!1,searching:!1,bInfo:!1,ordering:!1}),$(document).on("click",function(t){t.target.id,$("#no_div").hide()}),0==stack&&$.ajax({url:SITE_URL+"/stock_transfer/delete",type:"post",dataType:"json",data:{_token:token,id:$("#transfer_id").val()},success:function(t){window.location.replace(SITE_URL+"/stock_transfer/list")}}),$("#transferTbl").on("click",".delete_item",function(){var t=$(this).attr("data-id");(stack=jQuery.grep(stack,function(e){return e!=t})).pop(t),$(this).closest("tr").remove(),stack.splice($(this).attr("data-id"));var e=calculateTotalQty();$("#total_qty").text(getDecimalNumberFormat(e))}),$("#search").autocomplete({source:function(t,e){var a=$("#source").val();$.ajax({url:SITE_URL+"/stock_transfer/search",type:"post",dataType:"json",data:{_token:token,transfer_id:info_id,search:t.term,location:a},success:function(t){if(1==t.status_no){$("#val_item").html();t=t.items;$("#no_div").css("display","none"),e($.map(t,function(t){return{id:t.id,value:t.name,available:t.available,is_stock_managed:t.is_stock_managed}}))}else $(".ui-menu-item").remove(),$("#no_div").css("display","block")}})},select:function(t,e){var a=e.item;if(a.id){if(1==a.is_stock_managed&&a.available<=0&&swal(a.available+jsLang(" item(s) available in stock"),{icon:"error",buttons:[!1,jsLang("Ok")]}),in_array(a.id,stack)){var r=$("#qty_"+a.id).attr("data-max"),n=validateNumbers($("#qty_"+a.id).val());1==a.is_stock_managed&&r<parseFloat(n)+1?swal(r+jsLang(" item(s) available in stock"),{icon:"error",buttons:[!1,jsLang("Ok")]}):Number.isInteger(parseFloat(n))?$("#qty_"+a.id).val(parseInt(++n)):$("#qty_"+a.id).val(getDecimalNumberFormat(++n))}else{var i='<tr class="addedRow" id="rowid'+a.id+'"><td class="text-center">'+a.value+'<input type="hidden" name="new_description[]" value="'+a.value+'"><input type="hidden" name="new_stock[]" value="'+a.id+'"></td><td> <input class="form-control text-center no_units positive-float-number" data-id="'+a.id+'" data-rate="'+a.price+'" type="text" id="qty_'+a.id+'" value="1" name="new_item_quantity[]"><label id="qty_'+a.id+'-error" class="error labelMinMax" for="qty_'+a.id+'"></label><div class="availableStock color_red f-bold" id="errorMessage-'+a.id+'"></div><input type="hidden" name="new_item_id[]" value="'+a.id+'"></td><td class="text-center"><button id="'+a.id+'" data-id="'+a.id+'" class="btn btn-xs btn-danger delete_item"><i class="feather icon-trash-2"></i></button></td></tr>';$("#item-body").append(i),stack.push(a.id)}$(this).val(""),$("#qty_"+a.id).trigger("change");var o=calculateTotalQty();return $("#total_qty").text(getDecimalNumberFormat(o)),!1}},minLength:1,autoFocus:!0}).on("focus",function(){$(this).autocomplete("search")}).autocomplete("instance")._renderItem=function(t,e){var a;return a=1==e.is_stock_managed?e.available:"-",$("<li>").append("<div>"+e.value+"<br>Available: "+a+"</div>").appendTo(t)},$(window).keydown(function(t){if(13==t.keyCode)return t.preventDefault(),!1});let t=0;function calculateTotalQty(){var t=0;return $(".no_units").each(function(){t+=parseFloat($(this).val()?validateNumbers($(this).val()):0)}),0==t?(swal(jsLang("Please select at least one item."),{icon:"error",buttons:[!1,jsLang("Ok")]}),$("#btnSubmit").attr("disabled","true")):t>0&&$("#btnSubmit").removeAttr("disabled"),t}function deleteAddedRows(){$(".addedRow").each(function(){$(this).closest("tr").remove()})}$(document).on("keydown",".no_units",function(e){t=$(this).val()}),$(document).on("keyup change input",".no_units",function(e){$(this).attr("stock-id");var a=parseFloat(validateNumbers($(this).val())),r=parseFloat($(this).attr("old-qty")),n=$("#token").val(),i=$("#source").val(),o=$(this).attr("data-id"),s=$("#qty_"+o).val().replace(/^\.|[^\d\.]/g,""),l=0;""==s&&$("#qty_"+o).val(""),$.ajax({method:"POST",url:SITE_URL+"/stock_transfer/check-item-qty",data:{item_id:o,source:i,_token:n}}).done(function(e){e=JSON.parse(e);if(void 0===r||null==r||isNaN(r)){r=0,$("#qty_"+o).attr("data-max",Number(r)+Number(e.qty));var n=$("#qty_"+o).attr("data-max");if(Number(a)>Number(n))return $("#qty_"+o).val(t),swal(e.qty+jsLang(" item(s) available in stock"),{icon:"error",buttons:[!1,jsLang("Ok")]}),$("#qty_"+o).val(t),$("#qty_"+o).trigger("change"),getDecimalNumberFormat(t);l=calculateTotalQty(),$("#total_qty").text(getDecimalNumberFormat(l))}else{$("#qty_"+o).attr("data-max",Number(r)+Number(e.qty));n=$("#qty_"+o).attr("data-max");if(Number(a)>Number(n))return $("#qty_"+o).val(t),swal(e.qty+jsLang(" item(s) available in stock"),{icon:"error",buttons:[!1,jsLang("Ok")]}),$("#qty_"+o).val(t),l=calculateTotalQty(),$("#total_qty").text(getDecimalNumberFormat(l)),getDecimalNumberFormat(t);l=calculateTotalQty(),$("#total_qty").text(getDecimalNumberFormat(l)),$("#errorMessage-"+o).html(e.message),Number(e.qty)>=Number(a)-Number(r)?$("#errorMessage-"+o).html(""):(isNaN($("#qty_"+o).val())?$("#qty_"+o).val(a):""==$("#qty_"+o).val()&&$("#qty_"+o).val(""),$("#errorMessage-"+o).html(e.message)),l=calculateTotalQty(),$("#total_qty").text(getDecimalNumberFormat(l)),$("#btnSubmit").removeAttr("disabled")}n=$("#qty_"+o).attr("data-max");if(Number(a)>Number(n))return swal(e.qty+jsLang(" item(s) available in stock"),{icon:"error",buttons:[!1,jsLang("Ok")]}),!1}),l=calculateTotalQty(),$("#total_qty").text(getDecimalNumberFormat(l))}),$("#transferForm").validate({rules:{source:{required:!0},destination:{required:!0},transfer_date:{required:!0},"new_item_quantity[]":{required:!0},"item_quantity[]":{required:!0}},submitHandler:function(){return 0!=document.getElementsByClassName("addedRow").length||(swal({text:jsLang("Please select at least one item to transfer"),icon:"error",buttons:[!1,jsLang("Ok")],dangerMode:!0}),!1)}}),$(document).on("click",".no_units",function(t){$(".labelMinMax").css("display","none")}),$(document).on("click",function(t){$(".labelMinMax").css("display","none"),$(".labelMinMax").css("position","fixed")}),$("#transferTbl").addClass("stock-transfer-edit")}